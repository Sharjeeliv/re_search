{% extends 'base.html' %} 
{% block title %} {{ title }} {% endblock %} 
{% block content %} 
<div class="container mb-5 col-lg-6 col-md-8">
    <h1>Task Progress</h1>
    <div class="progress mb-3" style="height: 30px;">
        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
    <div id="result-message" class="alert alert-success" style="display: none;"></div>
    <a id="download-button" href="#" class="btn btn-primary" style="display: none;" download>Download PDF</a>
    <form id="cancel-form" method="POST" action="">
        <button id="cancel-button" class="btn btn-danger" type="submit">Cancel Task</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        const jobId = '{{ job_id }}';

        function updateProgress() {
            $.get('/job-status/' + jobId)
                .done(function(data) {
                    if (data.status === 'finished') {
                        $('#progress-bar').css('width', '100%').attr('aria-valuenow', 100).text('100%');
                        $('#result-message').text('Processing complete, report available for download').show();
                        $('#download-button').attr('href', '/download/' + data.result).show();
                        clearInterval(progressInterval);
                    } else if (data.status === 'started') {
                        $('#progress-bar').css('width', data.progress + '%').attr('aria-valuenow', data.progress).text(Math.round(data.progress) + '%');
                    } else if (data.status === 'queued' || data.status === 'failed') {
                        $('#progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%');
                        if (data.status === 'failed') {
                            $('#error-message').text('Task failed. Please try again.').show();
                        }
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching job status:", textStatus, errorThrown);
                });
        }

        const progressInterval = setInterval(updateProgress, 1000);

        $('#cancel-form').on('submit', function(event) {
            event.preventDefault();
            $.post('/cancel-job/' + jobId)
                .done(function(data) {
                    if (data.status === 'canceled') {
                        $('#progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('Canceled');
                        $('#cancel-button').attr('disabled', true); // Disable cancel button after canceling
                        clearInterval(progressInterval);

                        setTimeout(function() {
                            window.location.href = '/';
                        }, 1000); // Redirect after 1 second
                    } else {
                        $('#error-message').text('Unable to cancel task.').show();
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Error canceling job:", textStatus, errorThrown);
                });
        });
    });
</script>
{% endblock %}