{% extends 'base.html' %} 
{% block title %} {{ title }} {% endblock %} 
{% block content %} 
<div class="container mb-5 col-lg-6 col-md-8">
    <h1 class="text-center fw-bold">Zotero MECA</h1>
    <p class="font-monospace text-center">Metadata Extraction Citation Automation</p>
    <form id="task-form" method="POST" action="" enctype="multipart/form-data">
        {% if not lib_key %}
        <div class="input-group mb-3 shadow-sm rounded">
            <input type="text" class="form-control" placeholder="Enter Zotero Key" name="lib-key">
            <button class="btn btn-dark" type="submit">&rarr;</button>
        </div>
        {% elif not lib_id %}
        <div class="input-group mb-3 shadow-sm rounded">
            <input type="text" class="form-control" placeholder="Enter Zotero Library Id" name="lib-id">
            <button class="btn btn-dark" type="submit">&rarr;</button>
        </div>
        {% else %}
        <div class="input-group mb-3 shadow-sm rounded">
            <input type="file" class="form-control" name="file[]" webkitdirectory="" directory="" multiple>
            <button class="btn btn-dark" type="submit">&rarr;</button>
        </div>
        {% endif %}
        
        {% if pending_jobs %}
        <div class="progress mt-5" style="height: 30px;">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script>
            $(document).ready(function(){
                // Check if there's a job_id in the URL
                const urlParams = new URLSearchParams(window.location.search);
                const jobId = urlParams.get('job_id');
                
                if (jobId) {
                    // Start polling for job status
                    const interval = setInterval(function(){
                        $.get('/job-status/' + jobId, function(data){
                            if (data.status === 'finished') {
                                $('#progress-bar').css('width', '100%').attr('aria-valuenow', 100).text('100%');
                                clearInterval(interval);
                            } else if (data.status === 'started') {
                                $('#progress-bar').css('width', data.progress + '%').attr('aria-valuenow', data.progress).text(Math.round(data.progress) + '%');
                            } else if (data.status === 'queued' || data.status === 'failed') {
                                $('#progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%');
                            }
                        });
                    }, 1000); // Poll every second
                }

                $('#task-form').on('submit', function(event){
                    event.preventDefault();
                    const formData = new FormData(this);
                    $.ajax({
                        type: 'POST',
                        url: '/',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            // Redirect to the same page to show the job ID in URL
                            window.location.href = '?job_id=' + response.job_id;
                        }
                    });
                });
            });
        </script>
        {% endif %}
    </form>
</div>
{% endblock %}