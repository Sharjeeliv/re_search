{% extends 'base.html' %} 
{% block title %} {{ title }} {% endblock %} 
{% block content %} 
<div class="container mt-5">
    <h1>Task Progress</h1>
    <div class="progress mb-3" style="height: 30px;">
        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
    <form id="cancel-form" method="POST" action="">
        <button id="cancel-button" class="btn btn-danger" type="submit">Cancel Task</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function(){
        const jobId = '{{ job_id }}';

        function updateProgress() {
            $.get('/job-status/' + jobId, function(data) {
                if (data.status === 'finished') {
                    $('#progress-bar').css('width', '100%').attr('aria-valuenow', 100).text('100%');
                    clearInterval(progressInterval);
                } else if (data.status === 'started') {
                    $('#progress-bar').css('width', data.progress + '%').attr('aria-valuenow', data.progress).text(Math.round(data.progress) + '%');
                } else if (data.status === 'queued' || data.status === 'failed') {
                    $('#progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%');
                    if (data.status === 'failed') {
                        $('#error-message').text('Task failed. Please try again.').show();
                    }
                }
            });
        }

        // Update progress every second
        const progressInterval = setInterval(updateProgress, 1000);

        // Handle cancel button click
        $('#cancel-form').on('submit', function(event) {
            event.preventDefault();
            $.get('/job-status/' + jobId, function(data) {
                if (data.status === 'started' || data.status === 'queued') {
                    $.post('/cancel-job/' + jobId, function(data) {
                        if (data.status === 'canceled') {
                            $('#progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('Canceled');
                            $('#cancel-button').attr('disabled', true); // Disable cancel button after canceling
                            clearInterval(progressInterval);
                        }
                    });
                } else {
                    $('#error-message').text('Task cannot be canceled.').show();
                }
            });
        });
    });
</script>
{% endblock %}